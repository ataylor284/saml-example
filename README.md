SAML Example
============

A simple SAML application built with opensaml and pac4j to understand the SAML webflow.

An example SAML authentication webflow:

There are three parties involved in the authentication: the *user's
browser*, the Service Provider *(SP) - saml-example in this example*, and
the Identity Provider *(IDP)*.  The IDP can be any SAML 2.0 identity
provider.

The negotiation looks like this:

![Sequence Diagram](http://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/ataylor284/saml-example/master/sequence.puml)

First, note that the SP and IDP never directly interact.  All the
requests go from browser to SP or browser to IDP.

Request 1 is to a secure resource on the SP.  The SP doesn't have an
authenticated session for the browser, so it returns a special "SAML
Login 1" response.  This is generated by pac4j and opensaml in
saml-example.  The response is a form that auto-submits itself
(request 2) to the IDP.  The form includes a SAMLRequest parameter
that encodes its identity.

The IDP determines the user is not yet authenticated, and presents a
login form where the user enters their IDP creds (requests 3 and 4).

The response to the successful login is another auto-submitting form,
this time with a SAMLResponse parameter.  This is auto-submitted to
the SP callback URL.

When the form is submitted the SP decodes the SAMLResponse and gets
the user credentials and profile.  Done!

Using the example
-----------------

Create a java keystore and create a key pair with alias saml in the current directory.

    keytool -genkey -keyalg RSA -alias saml -keypass changeit -keystore trust.keystore -storepass changeit

Copy the IDP metadata XML document to
`src/main/resources/idp-metadata.xml`.

Build (`mvn compile`), run (`mvn exec:java -Dexec.mainClass="ca.redtoad.Main"`) and browse to http://localhost:8080.

Testing on samltest.id
----------------------

To test this project against https://samltest.id saml service (there is IdP and also SP),
you first need to prepare your custom sp metadata, with custom entityID.
One minimal example generated on online tool, https://www.samltool.com/sp_metadata.php
is in `sp-metadata.xml` in this repo.

Most important is entityId (in sample file, `http://localhost:8080/callback?skúškaaaa`).
Another important info in this file is a callback url. It contains domain, path and
client name. Client name is configured in `SAML2ClientBuilder` class and it is
set to `SAMLExample`. We can keep it as-is.
EntityId is also used by samltest.id service as a primary key when uploading config.
Then [upload](https://samltest.id/upload.php) your sp-metadata.xml to the service.

Change your entityId also in source code, in `SAML2ClientBuilder` class, there is
a call to `config.setServiceProviderEntityId` method.

To obtain `idp-metadata.xml` file, you can go to https://samltest.id/download/ page and
download given file
(Direct link is https://samltest.id/saml/idp, and you need to save it
to `src/main/resources/idp-metadata.xml` file).
